---
layout: post
title:  "在线实验笔记"
date:   2020-08-03 18:22:00
categories: 技术工具 数学基础
tags: A/B实验 假设检验
excerpt: 互联网公司常用的在线实验方法讲解
author: 鹤啸九天
mathjax: true
---

* content
{:toc}

# 总结

- [Innovating Faster on Personalization Algorithms at Netflix Using Interleaving](https://medium.com/netflix-techblog/interleaving-in-online-experiments-at-netflix-a04ee392ec55)

# 数学知识

## 什么是显著性检验

- “`显著性检验`”的英文名称是“significance test”。在统计学中，显著性检验是“**统计假设检验**”(Statistical hypothesis tesing)的一种，显著性检验是检测科学实验中的<font color='blue'>实验组与对照组之间是否存在差异及差异是否显著</font>的办法。
- “统计假设检验”指出了“显著性检验”的前提条件是“统计假设”，换言之“无假设，不检验”。任何人在使用显著性检验之前必须知道假设是什么。
- 一般而言，把要检验的假设称之为`原假设`，记为H0，把与H0相对应的假设称之为`备择假设`，记为H1。
    - 第一类错误-**弃真**（α）：如果原假设为真，而检验的结论却劝你放弃原假设，称为**第一类错误**，出现的概率记为α。
    - 第二类错误-**存伪**（β）：如果原假设不为真，而检验的结论却劝你接受原假设，称为**第二类错误**，出现的概率记为β。
- 通常只限定犯第一类错误的最大概率α， 不考虑犯第二类错误的概率β。这样的假设检验称为`显著性检验`，概率α称为`显著性水平`。
- 显著性水平是数学界约定俗成的，一般有α =0.05,0.025.0.01这三种情况。代表着显著性检验的结论错误率必须低于5%或2.5%或1%（统计学中，通常把在现实世界中发生几率小于5%的事件称之为“**不可能事件**”）（问：不是小概率事件吗？）。

## 什么是卡方检验

- 卡方检验(Chi-Square Test)在大数据技术场景中，通常用来检验某个变量或特征是不是**和应变量有显著关系**。
- 如：观察性别和在线买不买生鲜食品有没有关系。
    - ![](https://math.jianshu.com/math?formula=X%5E%7B2%7D%3D%5CSigma%20%5Cfrac%7B(observed-expected)%5E2%7D%7Bexpected%7D)

## 假设检验基本理论
-------

- 参考：[用Python如何实现“假设检验”](https://zhuanlan.zhihu.com/p/50190968)

![](https://pic4.zhimg.com/80/v2-f9031f3a6fe3328584e9df11d4b93fd5_720w.jpg?source=1940ef5c)

假设检验现实生活实例可参考 [假设检验的逻辑是什么？](https://www.zhihu.com/collection/288499050)
 
1. 先确定原假设（零假设）和备则假设
    - 原假设（H0）：某个断言
    - 备则假设（H1）：原假设对立的断言
2. 假设检验实际是对假设检验的断言进行试验，你对假设保持怀疑，随后如果有足够的拒绝证据，则拒绝；
3. 假设检验无法给出绝对的证明，假定原假设为真的前提下，通过假设检验了解结果到底有多可靠。如果结果极不可能发生，就会成为证明原假设为假的证据
4. 基本概念：
    * 检验统计量：用于对假设进行检验的统计量  
    * 显著性水平：用 α 表示， 表明希望在观察结果的不可能程度达到多大时，拒绝H0;

P(X<c) < α 其中X为检验统计量，c为临界值，α为显著性水平。
 
如果α=5%，表示如果样本中的检验中的检验统计量落在概率分布的最低5%范围内，将否定断言（原假设H0）
 
![](https://pic4.zhimg.com/80/v2-1ebfdc371235086068e7aa6eff21c2ee_720w.jpg)
 
* P值：某个小于或者等于拒绝域方向上的一个样本数值的概率；它是取得样本中的各种结果或者取得拒绝域方向上的某些更为极端的结果的概率；P值是在假定原假设为真时，得到与样本相同或者更极端的结果的概率。
    
- 如果P只位于拒绝域中，则拒绝H0；
- 如果P只位于拒绝域外，则没有充足证据，那么接受H0
 
5. 假设检验分类：（主要通过备则假设判断）
    * 单尾检验：拒绝域落在数据集一侧

* 如果H1是 '<' 符号 左尾 此时拒绝域位于数据的低端
 
![](https://pic2.zhimg.com/80/v2-ad9cf12c11e5f550bb87ae4603565b81_720w.jpg)
 
* 如果H1是 '>' 符号 右尾
 
![](https://pic4.zhimg.com/80/v2-e3c2a7f4d5b37110c6b633ecec8f2d7b_720w.jpg)
 
举例：某制药公司断言，某款药品针对某种病治愈率为90%患者，那么
- 原假设H0：P=0.9
- 备则假设H1: P<0.9
 
这就是左尾检验

无论是左尾检验还是右尾检验，P<α 即拒绝H0。 
*   双尾检验：拒绝域一分为而于数据集两侧

如果H1是 '≠' 符号 双尾
 
![](https://picb.zhimg.com/80/v2-d56ae1398ef74e216da2ba3e66896801_720w.jpg)
 
如果备则假设H1≠0.9， 则我们应使用双尾检验，我们应该查看检验统计量是否显著多于90%或者显著少于90%。
 
![](https://pic3.zhimg.com/80/v2-4bc25346eee2a7f31cda02149622543d_720w.jpg)
 
6. 几个概念的区别
 
* 置信区间：代表“总体参数位于两个极限之间”这一结果的具有的可信程度  
* 置信水平：总体参数位于置信区间的概率
* 显著性水平：反映数值位于某个极限以外的概率，一般为5%
    
 
显著性水平越小，则证据力度越大；为了拒绝H0，样本结果需要达到的不可能程度越高。

7. 假设检验六个步骤：
 
*   确定进行检验的假设（H0, H1）    
*   选择检验统计量
*   确定拒绝域
*   求出检验统计量的P值
*   查看样本结果是否位于拒绝域为
*   做出决策


# A/B实验

## 什么是A/B测试

- A/B测试是一种用于提升App/H5/小程序产品转化率、优化获客成本的数据决策方法。

![](https://pic1.zhimg.com/80/v2-11077994efe44dbf82e6512608dd2260_720w.jpg)

## A/B的意义

- 基于A/B测试的灰度发布更重要的不是优化，而是保护性发布，先通过小流量的实际用户测试，有BUG或者新版本体验不好，可以立即回滚到老版本，简单有效。
- ![](https://pic4.zhimg.com/80/72cdd3a4d3bba3ba4a4f0be795be831f_720w.jpg?source=1940ef5c)
- ![](https://pic2.zhimg.com/80/v2-313699ae4192816761bdcb7301c62112_720w.jpg?source=1940ef5c)

### 辛普森悖论

- 辛普森悖论（Simpson's Paradox）亦有人译为辛普森诡论，为英国统计学家E.H.辛普森（E.H.Simpson）于1951年提出的悖论，即在某个条件下的两组数据，分别讨论时都会满足某种性质，可是一旦合并考虑，却可能导致相反的结论。

### 区群谬误

- 区群谬误（Ecological fallacy），又称生态谬误，层次谬误，是一种在分析统计资料时常犯的错误。和以偏概全相反，区群谬误是一种以全概偏，如果仅基于群体的统计数据就对其下属的个体性质作出推论，就是犯上区群谬误。这谬误假设了群体中的所有个体都有群体的性质(因此塑型(Sterotypes)也可能犯上区群谬误)。区群谬误的相反情况为化约主义（Reductionism)。

### 解决

- 很多的测试行为并不科学，特别是很多定向的用户测试经常会有这个弊端
- 要解决这个问题，对采样、聚类、流量分割等要求非常的高，这也是为什么A/B测试工具不能像很多统计工具一样，埋个点看数据，再根据数据反推业务逻辑，而是要充分与业务结合，从一开始就应该考虑业务策略，让用户去选择适合其口味的产品。


## 灰度发布

- A/B测试就是上两个方案，部署后看效果。根据效果和一些结果参数决定采用哪个方案。
- 灰度发布是切一部分业务使用新方案，看效果如何，是否有bug，会遇到什么问题。如果一切OK，就把全部业务切到新的方案上执行。
- A/B测试系统的一个常用场景是App/小程序/后端服务精细化运营过程中的上线迭代管理，通常被称为灰度测试或者灰度上线。

![](https://pic1.zhimg.com/80/v2-a5bfd4a6e475603afe930b26f7b2eff4_720w.jpg?source=1940ef5c)

## 抽样策略

- 在灰度测试的技术实现里，一个关键的部分是试用用户样本的选择策略。也就是说，新版本上线测试的首批（以及后续批次）灰度用户是怎么筛选出来，决定了灰度测试的技术选型和具体实现。每一个新功能分别由哪些测试用户来试用，谁扮演“小白鼠”的角色
- 广泛使用的样本选择策略
    - 白名单
    - 随机抽样
    - 按照某种规则抽样
    - A/B测试科学采样


## A/B实验三大特性

- A/B测试具有三大特性：先验性、并行性和科学性。
    - 先验性：互联网以往的方式是先发布版本，再通过数据验证效果，分析版本的好坏。而A/B 测试是通过采用代表性样本、用户流量划分以及小流量测试等方式，来获得具有代表性的试验结论。简单来说，就是先通过低代价，小流量的试验，再推广到全流量的用户。
    - 并行性：将两个或两个以上的版本同时试验，确保每个版本所处环境的一致性，即其他条件都相同，同时发布同时生效，这样便于更加科学客观地进行对比。同时，可以节省验证的时间，无需在验证完一个版本之后再验证另一个。
    - 科学性：即用户流量分配的科学性。将相似特征的用户均匀的分配到试验组中，确保每个组别的用户特征的相似性，从而避免出现数据偏差，使得试验的结果更有代表性。

## A/B 测试的使用误区

- 误区一：轮流展现不同版本
    - 先发布A版本一段时间后，再发布B版本，通过对比两个版本的数据情况来评定版本的好坏。这种做法并不能保证每个版本所处的环境相同，受众群体可能会有明显区别。以至于难以判断最终效果是否有差异，或导致效果不同的原因。
    - 正确做法：不同版本并行（同时）上线试验，尽可能降低所有版本的测试环境差别。
- 误区二：选择不同应用市场投放/随机选取用户测试
    - 将不同版本打包，分别投放到不同的应用市场，最终根据数据反馈最优的版本，将该版本全量上线。或随机选取一部分用户（甚至是公司内部人员）进行前期试用，根据数据反馈决定迭代版本。这种做法违背A/B测试的科学流量分配的原则。
    - 正确做法：科学的进行流量分配，保证每个试验版本的用户特征类似。
- 误区三：让用户自主选择版本
    - 同时发布多个版本，在产品界面提供版本入口，由用户自主选择使用哪一版本，再根据数据进行分析，从而评估出最好版本。这种做法无法预估每个版本的用户数、用户使用时长以及用户特征，最终导致了试验结果的不准确。正确做法：让用户展现对不同版本的真实使用体验，应实时关注各版本的数据表现，并根据数据反馈及时调整试验流量。
- 误区四：对试验结果的认知和分析过浅
    - 这一误区又包括了两个不同的内容：
        - 认为只有当试验版本结果优于原始版本时，试验才算成功。事实上，A/B 测试是用于选择最佳版本的工具。试验可能出现的结果分为三种：试验版本有提升（试验版本最佳）、无明显差异（试验版本和原始版本均可）、试验版本的表现比原始版本糟糕（原始版本最佳），但这三种结果均可说明试验的成功。
        - 单从试验的整体数据结果，就推论所有场景的表现效果。例如：当A/B测试的数据表明试验版本差于原始版本时，就认定所有的地区或渠道的效果都是负面的。但如果细分每个版本中不同浏览器的数据，可能会发现：由于某一浏览器的明显劣势，导致整体试验数据不佳。
    - 因此，不要只专注于试验数据的整体表现，而忽略了细分场景下可能导致的结果偏差。
    - 正确做法：在分析试验整体数据的同时，需要从多个维度细分考量试验数据结果

## A/B方案

- AB实验的基本原理是“控制变量法”。
- 设指标数值=F（{隐变量列}、{显变量列（含方案变量）}）


# interleaving

- abtest的好处是能够对多个策略的效果差异给出定量的评估，但是也存在一些问题，比如，如果两个策略的效果差异较小，abtest容易给出波动较大的结果，需要较长时间（一般是一周）才能判断结果，会导致效果迭代速度较慢。
- 为了解决这个问题，采用interleaving效果评估方式作为补充。
- Interleaving方式的好处是所需流量较小，灵敏度较高，一般24小时之内可以给出结论，但是它**只能给定性结论而不能给定量结论**。
- Interleaving的基本思想是把两个策略的结果混合在一起，通过统计分析用户选择哪个策略的概率更大。具体列表混合的实现方式有多种。下面介绍比较简单使用的一种，叫Balanced方式。

# 结束


