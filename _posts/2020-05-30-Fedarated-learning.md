---
layout: post
title:  "联邦学习-Federated Learning"
date:   2020-05-30 08:27:00
categories: 机器学习
tags: 机器学习 联邦学习 同态加密
excerpt: 如何保护用户隐私的同时也能充分利用各类数据？
author: 鹤啸九天
mathjax: true
---

* content
{:toc}

# 总结

- 【2020-8-6】联邦学习Python实践：[Federated Learning Demo in Python using Socket Programming](https://github.com/ahmedfgad/FederatedLearning)
- 【2021-1-8】[字节跳动在联邦学习领域的探索及实践](https://www.toutiao.com/i6915250800906338819/)，联邦学习在广告投放和金融等场景中的应用模式、算法研究、软件系统及实践经验
- 【2021-3-14】[联邦学习:Tensorflow中的逐步实现](https://www.toutiao.com/i6814051104825803278/)

# 联邦学习介绍

## 常规机器学习的问题

- “集中式”模型训练
    - 设备(pc/phone)→服务器→API/gRPC
- 问题
    - 无法保证用户隐私保护——数据被服务器收集
    - 那以保证低时延——实时服务

## 大数据时代的机器学习困境

- 小数据
    - 数据和特征是模型和算法的上确界
    - 高质量、有标准的数据往往是小数据
- 数据孤岛
    - 中国的数据主要掌握在政府、运营商、互联网企业等三大“数据岛屿群”中，岛屿群间相互割裂，彼此孤立，甚至在岛屿群内部，或某一特定岛屿（企业）中，数据也并不是一个可方便流通的整体，而呈各自分散的“岛中岛”状态。
- 安全隐私
    - 5月6日，脱口秀演员王越池（艺名“池子”）在微博发布长文指责中信银行上海虹口支行在未经其本人授权的情况下，向与其有经济纠纷的笑果文化泄露其个人账户交易明细，再次引发人们对于自身信息安全的热议
    - 央视：别把用户信息扔出池子！

## 隐私保护立法

- 国际
    - 2018年6月13日，英国Dixons Carphone （跨国电信公司）宣布调查“大量客户数据被非法访问”事件。黑客“试图在Currys PC World和Dixons旅行商店的一个处理系统中破坏客户590万张卡和120万张包含非财务数据的记录，如姓名、地址或电子邮件地址……”这是英国有史以来最大的数据泄露事件
    - 1998年英国数据保护法
    - 2018年，欧盟一般数据保护条例（GDPR）生效
        - 2019年1月22日，法国监管机构对Google开出了首笔GDPR罚款，金额达5000万欧元（约5700万美元）
        - GDPR其中一条：可以用来大数据分析，提升用户体验，但不能用于别的场景，如训练对话系统等
- 国内

## 什么是联邦学习

- 2017 年 Google 发表 Federated Learning
- Blaise：
    - 能否用一个大型分布式神经网络模型训练框架，让用户数据不出本地（在自己的设备中进行训练）的同时也能获得相同的服务体验？
    - 可以！上传权重，而不是数据
        - 人会在睡觉的时候通过做梦来更新自己的大脑认知系统；
        - 同样设备终端的系统也可以通过闲置时进行模型训练和更新。
    - 设备端联邦学习
        - 用户本地训练，加密上传训练模型（权重），服务器端会综合成千上万的用户模型后再反馈给用户模型改进方案

![](https://static.leiphone.com/uploads/new/images/20200414/5e9594ab3e6b6.png)

# 联邦学习原理

【2021-5-17】[终于有人把联邦学习讲明白了](https://mp.weixin.qq.com/s/TRmZiXR3Ls3mUB1jN_9Rzg)

**联邦学习**是一种带有隐私保护、安全加密技术的分布式机器学习框架，旨在让分散的各参与方在满足不向其他参与者披露隐私数据的前提下，协作进行机器学习的模型训练。

经典联邦学习框架的训练过程可以简单概括为以下步骤：
- 协调方建立基本模型，并将模型的基本结构与参数告知各参与方；
- 各参与方利用本地数据进行模型训练，并将结果返回给协调方；
- 协调方汇总各参与方的模型，构建更精准的全局模型，以整体提升模型性能和效果。

联邦学习框架包含多方面的技术，比如传统机器学习的模型训练技术、协调方参数整合的算法技术、协调方与参与方高效传输的通信技术、隐私保护的加密技术等。此外，在联邦学习框架中还存在激励机制，数据持有方均可参与，收益具有普遍性。

Google首先将联邦学习运用在Gboard（Google键盘）上，联合用户终端设备，利用用户的本地数据训练本地模型，再将训练过程中的模型参数聚合与分发，最终实现精准预测下一词的目标。

除了分散的本地用户，联邦学习的参与者还可以是多家面临**数据孤岛困境**的企业，它们拥有独立的数据库但不能相互分享。联邦学习通过在训练过程中设计加密式参数传递代替原有的远程数据传输，保证了各方数据的安全与隐私，同时满足了已出台的法律法规对数据安全的要求。


## 联邦？

- 一种国家政体几个成员国（如共和国或邦、州等）联合组成统一国家​
- 联邦同成员国间的权限划分由联邦宪法规定。​
- 各成员国按联邦宪法规定，设自己的立法机关和行政机关，制定自己的宪法和法律，在自己辖区内行使职权。​
    - 如：美国、加拿大、澳大利亚、英国、俄罗斯、巴基斯坦等​
- 邦联：多个国家结盟，邦联包含联邦

## 联邦学习的架构思想

联邦学习的架构分为两种，一种是**中心化**联邦（客户端/服务器）架构，一种是**去中心化**联邦（对等计算）架构。
- 针对联合多方用户的联邦学习场景，一般采用的是客户端/服务器架构，企业作为服务器，起着协调全局模型的作用；
- 而针对联合多家面临数据孤岛困境的企业进行模型训练的场景，一般可以采用对等架构，因为难以从多家企业中选出进行协调的服务器方。

在客户端/服务器架构中，各参与方须与中央服务器合作完成联合训练，如图2-1所示。当参与方不少于两个时，启动联邦学习过程。

## 联邦学习基本过程

- 要点
    - 上传非对称加密的权重到服务器，云端算法聚合，更新模型并下发
- 设备端联邦学习过程
    - 设备端下载当前版本的模型；
    - 通过学习本地数据来改进模型；
    - 把对模型的改进，概括成一个比较小的更新；
    - 该更新被加密发送到云端；
    - 与其他用户的更新即时整合，作为对共享模型的改进。
- 关键环节
    - 根据用户使用情况，每台手机在本地对模型进行个性化改进；
    - 形成一个整体的模型修改方案；
    - 应用于共享的模型。该过程会不断循环。

## 同态加密

- 同态性源自抽象代数（近世代数），群、环、域、理想、四元数
- 同态加密是其中一个应用
- 原理
    - 加密算法可以隔着加密层去进行运算，完成任意算法的运算
    - 类似线性代数里的加法+数乘运算
![](https://static.leiphone.com/uploads/new/images/20200414/5e959561390ef.png)

# 联邦学习分类

## 总结

- 联邦学习具有以下特点：
    - 在联邦学习的框架下，各参与者地位对等，能够实现公平合作；
    - 数据保留在本地，避免数据泄露，满足用户隐私保护和数据安全的需求；
    - 能够保证参与各方在保持独立性的情况下，进行信息与模型参数的加密交换，并同时获得成长；
    - 建模效果与传统深度学习算法建模效果相差不大；
    - 联邦学习是一个「闭环」的学习机制，模型效果取决于数据提供方的贡献。

## 横向联邦学习

- 横向联邦学习是每行过来都可以看作一个用户的数据。按照用户来分，可以看作一、二、三个手机，它叫横向学习。还有一个原因是它们的纵向都是特征，比如手机型号、手机使用时间、电池以及人的位置等，这些都是特征。他们的特征都是一样的，样本都是不一样的，这是横向联邦学习。
- ![](https://static.leiphone.com/uploads/new/images/20200414/5e959576393d8.png)
- 主要做法是首先把信用评级得到，然后在加密状态下做聚合，这种聚合里面不是简单的加，而是很复杂的加，然后把征信模型再分发下来。

## 纵向联邦学习

- 大家的Feature不一样，一个机构红色、一个机构蓝色，大家可以想象两个医院，一个病人在红色医院做一些检测，在蓝色的医院做另外一些检测，当我们知道这两个医院有同样一群病人，他们不愿意直接交换数据的情况下，有没有办法联合建模？
- 它们中间有一个部门墙，我们可以在两边各自建一个深度学习模型，建模的时候关键的一步是梯度下降，梯度下降我们需要知道几个参数，上一轮参数、Loss（gradients）来搭配下一个模型的weight参数。
- ![](https://static.leiphone.com/uploads/new/images/20200414/5e9595b1e7e7b.png)
- 这个过程中我们需要得到全部模型的参数级，这时候需要进行交换，交换的时候可以通过同态加密的算法，也可以通过secure multiparty computation，这里面有一系列的算法，两边交换加密参数，对方进行更新，再次交换参数，一直到系统覆盖。

## 联邦迁移学习

- 它们在特征上一样，或者在特征上不一样，但是他们的用户有些是有交集的，当用户和特征没有交集时，我们退一步想，我们可以把他们所在的空间进行降维或者升维，把他们带到另外的空间去。
- 在另外的空间可以发现他们的子空间是有交互的，这些子空间的交互就可以进行迁移学习。虽然他们没有直接的特征和用户的重合，我们还是可以找到共性进行迁移学习。
- ![](https://static.leiphone.com/uploads/new/images/20200414/5e9595db77aad.png)
- 总的来说，联邦学习的这种思想，事实上并不仅仅适用于设备用户数据的隐私保护和模型更新。
- 我们将设备用户抽象来看，视作数据的拥有者，可以是手机持有者，也可以是公司、医院、银行等；而服务器或云端视作模型共享综合平台。


- 联邦学习最重要的就是保护数据的可用而不可见，也就是数据的隐私保护，其研究有如下方面：
- 一是基于差分隐私的数据保护；
- 二是基于秘密共享的加密计算方法；
- 三是基于同态加密的加密计算方法。

# 应用

## 风控

- 在众多金融业务环节中，饱受数据隐私和孤岛效应困扰的信贷风控，无疑是实现联邦学习落地的最佳场景之一。
- 微众银行联邦学习团队指出，基于联邦学习的信贷风控解决方案，能够“在建模过程中，双方交换梯度值，类似于方向向量的概念，交换的是中间变量，不是原始数据。同时对这个中间变量还进行了同态加密，所以数据并不会出库，保证数据源和应用方的数据安全。”
- 联邦学习所采用的局部数据收集和最小化原则，将降低传统中心化机器学习方法带来的一些系统性隐私风险和成本，这样的效果也正契合了信贷风控的提升方向。
- 多维度联邦数据建模，风控模型效果约可提升12%，相关企业机构有效节约了信贷审核成本，整体成本预计下降5%-10%，并因数据样本量的提升和丰富，风控能力进一步增强。
- ![](https://static.leiphone.com/uploads/new/images/20200407/5e8c1c7e183b1.png)

## 医疗

- 医疗健康数据领域长期存在“信息孤岛”问题，不同地区甚至不同医院间的医疗数据没有互联，也没有统一的标准。与此同时，数据安全问题也存在着巨大挑战。
- 腾讯天衍实验室公开宣布，其联合微众银行研发的医疗联邦学习，在脑卒中预测的应用上，准确率在相关数据集中高达80%。
- ![](https://static.leiphone.com/uploads/new/images/20200414/5e958eeb8666e.png)

## 安防

- 微众银行AI部门副总经理陈天健透露，“在‘联邦视觉系统’项目中，通过联邦学习技术，整体模型的性能提升了15%，且模型效果无损失，极大地提升了建模效率。”
- ![](https://static.leiphone.com/uploads/new/images/20200414/5e95964ab81fd.png)

# 工程实现

- 开源FL工具包FATE
- Tensorflow工具包：FFT
- 【2021-3-14】[联邦学习:Tensorflow中的逐步实现](https://www.toutiao.com/i6814051104825803278/)
  - FL架构的基本形式包括一个位于中心的管理员或服务器，负责协调训练活动。客户端主要是边缘设备，可以达到数百万的数量。这些设备在每次训练迭代中至少与服务器通信两次。首先，它们各自从服务器接收当前全局模型的权重，在各自的本地数据上对其进行训练，以生成更新后的参数，然后将这些参数上传到服务器进行汇总。这种通信循环一直持续到达到预先设定的epochs数或准确度条件为止。在联邦平均算法中，汇总仅仅意味着平均操作。
  - ![](https://p6-tt.byteimg.com/origin/pgc-image/66d33ac16b7e4951870bb12b2a6ae363?from=pc)
  - 在Tensorflow中从头开始构建一个FL，并在Kaggle的[MNIST数据集](https://www.kaggle.com/scolianni/mnistasjpg)上对其进行训练

# 资料

- [2019年全球架构师峰会](https://archsummit.infoq.cn/2019/shenzhen/schedule)
- 【InfoQ】[陈天健：基于联邦学习新技术连接数据孤岛](https://static001.geekbang.org/con/40/pdf/2790523233/file/%E9%99%88%E5%A4%A9%E5%81%A5-%E5%9F%BA%E4%BA%8E%E8%81%94%E9%82%A6%E5%AD%A6%E4%B9%A0%E6%96%B0%E6%8A%80%E6%9C%AF%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%AD%A4%E5%B2%9B.pdf)
- 2019-12, [54页PPT全解联邦学习中的同态运算与密文传输](http://t.10jqka.com.cn/pid_128844464.shtml)
- [联邦学习诞生1000天的真实现状](https:/www.leiphone.com/news/202004/rfPSGIjbS38DqTsm.html)
- [联邦学习tensorflow工具包](https://www.tensorflow.org/federated?hl=zh-cn)
- 书籍：杨强的《联邦学习》


# 结束


